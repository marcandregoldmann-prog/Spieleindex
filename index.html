<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f1923">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="description" content="Magdeburg Freizeitkarte ‚Äì Spielpl√§tze, Attraktionen & mehr entdecken">
    <title>Magdeburg Freizeitkarte</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0f1923;
            --bg-secondary: #162231;
            --bg-card: #1c2d3f;
            --bg-card-hover: #243a50;
            --bg-elevated: #2a4560;
            --bg-input: #162231;
            --text-primary: #e8f0f8;
            --text-secondary: #8ba4be;
            --text-muted: #5a7a96;
            --accent: #00d4aa;
            --accent-glow: rgba(0, 212, 170, 0.25);
            --accent-secondary: #ff6b6b;
            --accent-secondary-glow: rgba(255, 107, 107, 0.25);
            --accent-blue: #4facfe;
            --accent-blue-glow: rgba(79, 172, 254, 0.25);
            --accent-orange: #ffa726;
            --accent-orange-glow: rgba(255, 167, 38, 0.25);
            --accent-purple: #b388ff;
            --accent-purple-glow: rgba(179, 136, 255, 0.25);
            --accent-pink: #ff80ab;
            --accent-pink-glow: rgba(255, 128, 171, 0.25);
            --accent-yellow: #ffd740;
            --accent-yellow-glow: rgba(255, 215, 64, 0.25);
            --border: rgba(255,255,255,0.08);
            --border-accent: rgba(0, 212, 170, 0.3);
            --shadow: 0 8px 32px rgba(0,0,0,0.4);
            --shadow-sm: 0 4px 12px rgba(0,0,0,0.3);
            --radius: 16px;
            --radius-sm: 10px;
            --radius-xs: 6px;
            --transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-fast: 0.15s ease;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Nunito', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            min-height: 100dvh;
            overflow-x: hidden;
        }

        /* ===== BACKGROUND EFFECTS ===== */
        .bg-glow {
            position: fixed;
            width: 300px; height: 300px;
            border-radius: 50%;
            filter: blur(100px);
            opacity: 0.15;
            pointer-events: none;
            z-index: 0;
        }
        .bg-glow-1 { top: -100px; left: -50px; background: var(--accent); }
        .bg-glow-2 { bottom: -100px; right: -50px; background: var(--accent-blue); }

        /* ===== HEADER ===== */
        .header {
            position: fixed; top: 0; left: 0; right: 0;
            z-index: 1000;
            background: rgba(15, 25, 35, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            padding: 0 16px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .header-left { display: flex; align-items: center; gap: 10px; }
        .header-logo { font-size: 24px; }
        .header-title {
            font-weight: 800; font-size: 17px;
            background: linear-gradient(135deg, var(--accent), var(--accent-blue));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .header-right { display: flex; align-items: center; gap: 6px; }
        .header-btn {
            background: var(--bg-card); border: 1px solid var(--border);
            color: var(--text-primary); width: 40px; height: 40px;
            border-radius: var(--radius-sm); display: flex;
            align-items: center; justify-content: center;
            font-size: 18px; cursor: pointer; transition: var(--transition);
        }
        .header-btn:hover, .header-btn:active {
            background: var(--bg-card-hover);
            border-color: var(--border-accent);
        }
        .header-btn.active {
            background: rgba(0, 212, 170, 0.15);
            border-color: var(--accent);
            color: var(--accent);
        }

        /* ===== SEARCH BAR ===== */
        .search-bar {
            position: fixed; top: 60px; left: 0; right: 0;
            z-index: 999; padding: 10px 16px;
            background: rgba(15, 25, 35, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            transform: translateY(-100%);
            opacity: 0;
            transition: var(--transition);
        }
        .search-bar.visible { transform: translateY(0); opacity: 1; }
        .search-input-wrap {
            display: flex; align-items: center; gap: 10px;
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 0 14px; height: 46px;
        }
        .search-input-wrap .icon { font-size: 18px; opacity: 0.5; }
        .search-input {
            flex: 1; border: none; background: none;
            color: var(--text-primary); font-family: inherit;
            font-size: 15px; outline: none;
        }
        .search-input::placeholder { color: var(--text-muted); }
        .search-clear {
            background: none; border: none; color: var(--text-muted);
            font-size: 20px; cursor: pointer; padding: 4px;
            display: none;
        }
        .search-clear.visible { display: block; }

        /* ===== MAP ===== */
        #map {
            position: fixed;
            top: 60px; left: 0; right: 0; bottom: 70px;
            z-index: 1;
        }
        #map.search-open { top: 116px; }

        /* ===== MAP CONTROLS ===== */
        .map-controls {
            position: fixed;
            right: 14px; bottom: 150px;
            z-index: 500;
            display: flex; flex-direction: column; gap: 8px;
        }
        .map-ctrl-btn {
            width: 46px; height: 46px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: rgba(15, 25, 35, 0.9);
            backdrop-filter: blur(12px);
            color: var(--text-primary);
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
        }
        .map-ctrl-btn:hover, .map-ctrl-btn:active {
            background: var(--bg-card-hover);
            border-color: var(--accent);
            transform: scale(1.05);
        }
        .map-ctrl-btn.locating {
            animation: pulse-glow 1.5s infinite;
        }
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 0 0 var(--accent-glow); }
            50% { box-shadow: 0 0 0 12px transparent; }
        }

        /* ===== CATEGORY CHIPS (horizontal scroll) ===== */
        .category-bar {
            position: fixed;
            top: 60px; left: 0; right: 0;
            z-index: 998;
            padding: 8px 14px;
            display: flex; gap: 8px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            background: rgba(15, 25, 35, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }
        .category-bar.search-open { top: 116px; }
        .category-bar::-webkit-scrollbar { display: none; }
        .chip {
            flex-shrink: 0;
            padding: 7px 14px;
            border-radius: 20px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-secondary);
            font-size: 13px; font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
            display: flex; align-items: center; gap: 6px;
        }
        .chip:hover, .chip:active { background: var(--bg-card-hover); }
        .chip.active {
            background: rgba(0, 212, 170, 0.15);
            border-color: var(--accent);
            color: var(--accent);
        }
        .chip .count {
            background: var(--bg-elevated);
            padding: 1px 7px; border-radius: 10px;
            font-size: 11px; font-weight: 700;
        }
        .chip.active .count {
            background: rgba(0, 212, 170, 0.25);
        }

        /* ===== FAB (Add Button) ===== */
        .fab {
            position: fixed;
            right: 14px; bottom: 86px;
            z-index: 500;
            width: 58px; height: 58px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, var(--accent), #00b894);
            color: #fff;
            font-size: 28px; font-weight: 300;
            cursor: pointer;
            box-shadow: 0 6px 24px var(--accent-glow);
            display: flex; align-items: center; justify-content: center;
            transition: var(--transition);
        }
        .fab:hover, .fab:active {
            transform: scale(1.08) rotate(90deg);
            box-shadow: 0 8px 32px var(--accent-glow);
        }

        /* ===== BOTTOM NAV ===== */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            z-index: 1000;
            height: 70px;
            background: rgba(15, 25, 35, 0.92);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid var(--border);
            display: flex;
            padding-bottom: env(safe-area-inset-bottom, 0);
        }
        .nav-item {
            flex: 1;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            gap: 3px;
            color: var(--text-muted);
            font-size: 11px; font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            background: none; border: none;
            font-family: inherit;
            position: relative;
        }
        .nav-item .nav-icon { font-size: 22px; transition: var(--transition); }
        .nav-item.active { color: var(--accent); }
        .nav-item.active .nav-icon { transform: scale(1.15); }
        .nav-item.active::before {
            content: '';
            position: absolute; top: 0; left: 50%;
            transform: translateX(-50%);
            width: 30px; height: 3px;
            border-radius: 0 0 3px 3px;
            background: var(--accent);
        }
        .nav-item:hover { color: var(--text-secondary); }
        .nav-badge {
            position: absolute; top: 6px; right: calc(50% - 20px);
            background: var(--accent-secondary);
            color: #fff; font-size: 9px; font-weight: 800;
            padding: 1px 5px; border-radius: 8px;
            min-width: 16px; text-align: center;
        }

        /* ===== PANELS (Overlays for List, Stats, Settings) ===== */
        .panel {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            z-index: 2000;
            background: var(--bg-primary);
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .panel.open { transform: translateY(0); }
        .panel-header {
            position: sticky; top: 0; z-index: 10;
            background: rgba(15, 25, 35, 0.92);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            padding: 16px 20px;
            display: flex; align-items: center; justify-content: space-between;
        }
        .panel-header h2 {
            font-size: 20px; font-weight: 800;
            display: flex; align-items: center; gap: 10px;
        }
        .panel-close {
            width: 40px; height: 40px; border-radius: 50%;
            border: 1px solid var(--border); background: var(--bg-card);
            color: var(--text-primary); font-size: 20px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: var(--transition);
        }
        .panel-close:hover { background: var(--bg-card-hover); border-color: var(--accent-secondary); color: var(--accent-secondary); }
        .panel-body { padding: 20px; padding-bottom: 100px; }

        /* ===== MODAL (Add/Edit) ===== */
        .modal-overlay {
            position: fixed; inset: 0;
            z-index: 3000;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(6px);
            -webkit-backdrop-filter: blur(6px);
            opacity: 0; pointer-events: none;
            transition: opacity 0.3s;
        }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        .modal {
            position: fixed; left: 0; right: 0; bottom: 0;
            z-index: 3001;
            max-height: 92vh;
            background: var(--bg-secondary);
            border-radius: var(--radius) var(--radius) 0 0;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .modal.open { transform: translateY(0); }
        .modal-handle {
            width: 40px; height: 4px;
            background: var(--text-muted);
            border-radius: 2px;
            margin: 12px auto 0;
        }
        .modal-header {
            padding: 16px 20px 0;
            display: flex; align-items: center; justify-content: space-between;
        }
        .modal-header h2 { font-size: 20px; font-weight: 800; }
        .modal-body { padding: 16px 20px 32px; }

        /* ===== FORM ELEMENTS ===== */
        .form-group { margin-bottom: 18px; }
        .form-group label {
            display: block; font-size: 13px; font-weight: 700;
            color: var(--text-secondary); margin-bottom: 6px;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .form-input, .form-select, .form-textarea {
            width: 100%; padding: 12px 14px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-family: inherit; font-size: 15px;
            transition: var(--transition); outline: none;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }
        .form-textarea { min-height: 80px; resize: vertical; }
        .form-select { -webkit-appearance: none; appearance: none; cursor: pointer; }

        /* Category Selector Grid */
        .category-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;
        }
        .cat-option {
            padding: 10px 8px;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--bg-card);
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            font-size: 12px; font-weight: 600;
        }
        .cat-option .cat-icon { font-size: 24px; display: block; margin-bottom: 4px; }
        .cat-option:hover { background: var(--bg-card-hover); }
        .cat-option.selected { border-color: var(--accent); background: rgba(0, 212, 170, 0.1); color: var(--accent); }

        /* Star Rating */
        .star-rating { display: flex; gap: 6px; flex-direction: row-reverse; justify-content: flex-end; }
        .star-rating input { display: none; }
        .star-rating label {
            font-size: 32px; cursor: pointer;
            color: var(--text-muted); transition: var(--transition-fast);
        }
        .star-rating label:hover,
        .star-rating label:hover ~ label,
        .star-rating input:checked ~ label {
            color: var(--accent-yellow);
            text-shadow: 0 0 12px var(--accent-yellow-glow);
        }

        /* Status Toggle */
        .status-toggle {
            display: flex; gap: 8px;
        }
        .status-btn {
            flex: 1; padding: 10px;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--bg-card);
            color: var(--text-secondary);
            font-family: inherit; font-size: 13px; font-weight: 600;
            cursor: pointer; transition: var(--transition);
            display: flex; align-items: center; justify-content: center; gap: 6px;
        }
        .status-btn:hover { background: var(--bg-card-hover); }
        .status-btn.active-visited { border-color: var(--accent); color: var(--accent); background: rgba(0, 212, 170, 0.1); }
        .status-btn.active-wishlist { border-color: var(--accent-orange); color: var(--accent-orange); background: rgba(255, 167, 38, 0.1); }
        .status-btn.active-favorite { border-color: var(--accent-secondary); color: var(--accent-secondary); background: rgba(255, 107, 107, 0.1); }

        /* Photo Upload */
        .photo-upload {
            border: 2px dashed var(--border);
            border-radius: var(--radius-sm);
            padding: 20px; text-align: center;
            cursor: pointer; transition: var(--transition);
            position: relative; overflow: hidden;
        }
        .photo-upload:hover { border-color: var(--accent); background: rgba(0,212,170,0.05); }
        .photo-upload input { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
        .photo-upload .upload-icon { font-size: 32px; margin-bottom: 6px; }
        .photo-upload .upload-text { font-size: 13px; color: var(--text-muted); }
        .photo-preview {
            display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px;
        }
        .photo-thumb {
            width: 70px; height: 70px;
            border-radius: var(--radius-xs);
            object-fit: cover;
            border: 2px solid var(--border);
            position: relative;
        }
        .photo-thumb-wrap {
            position: relative; display: inline-block;
        }
        .photo-remove {
            position: absolute; top: -6px; right: -6px;
            width: 22px; height: 22px;
            border-radius: 50%; border: none;
            background: var(--accent-secondary);
            color: #fff; font-size: 14px;
            cursor: pointer; display: flex;
            align-items: center; justify-content: center;
        }

        /* Tags */
        .tags-input-wrap {
            display: flex; flex-wrap: wrap; gap: 6px;
            padding: 8px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            min-height: 44px; align-items: center;
            cursor: text;
        }
        .tags-input-wrap:focus-within { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }
        .tag {
            display: inline-flex; align-items: center; gap: 4px;
            padding: 3px 10px;
            background: rgba(0, 212, 170, 0.15);
            border: 1px solid rgba(0, 212, 170, 0.3);
            border-radius: 12px;
            font-size: 12px; font-weight: 600;
            color: var(--accent);
        }
        .tag-remove {
            background: none; border: none;
            color: var(--accent); font-size: 14px;
            cursor: pointer; padding: 0 2px;
        }
        .tag-input {
            border: none; background: none;
            color: var(--text-primary); font-family: inherit;
            font-size: 14px; outline: none;
            min-width: 80px; flex: 1;
        }
        .tag-input::placeholder { color: var(--text-muted); }

        /* Quick Tag Suggestions */
        .tag-suggestions {
            display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px;
        }
        .tag-sug {
            padding: 4px 10px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-muted);
            font-size: 11px; font-weight: 600;
            cursor: pointer; transition: var(--transition-fast);
        }
        .tag-sug:hover { border-color: var(--accent); color: var(--accent); }

        /* Submit Buttons */
        .form-actions {
            display: flex; gap: 10px; margin-top: 20px;
        }
        .btn {
            flex: 1; padding: 14px;
            border-radius: var(--radius-sm);
            border: none;
            font-family: inherit; font-size: 15px; font-weight: 700;
            cursor: pointer; transition: var(--transition);
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--accent), #00b894);
            color: #fff;
            box-shadow: 0 4px 16px var(--accent-glow);
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 24px var(--accent-glow); }
        .btn-secondary {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-primary);
        }
        .btn-danger {
            background: rgba(255, 107, 107, 0.15);
            border: 1px solid rgba(255, 107, 107, 0.3);
            color: var(--accent-secondary);
        }
        .btn-danger:hover { background: rgba(255, 107, 107, 0.25); }

        /* ===== LIST VIEW ITEMS ===== */
        .list-sort {
            display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap;
        }
        .sort-btn {
            padding: 6px 12px;
            border-radius: 16px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-muted);
            font-family: inherit; font-size: 12px; font-weight: 600;
            cursor: pointer; transition: var(--transition-fast);
        }
        .sort-btn.active { border-color: var(--accent); color: var(--accent); background: rgba(0,212,170,0.1); }

        .location-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 12px;
            transition: var(--transition);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        .location-card:hover { border-color: rgba(0,212,170,0.2); background: var(--bg-card-hover); }
        .location-card.favorite::before {
            content: ''; position: absolute; top: 0; left: 0;
            width: 4px; height: 100%;
            background: linear-gradient(to bottom, var(--accent-secondary), var(--accent-pink));
        }
        .location-card.wishlist::before {
            content: ''; position: absolute; top: 0; left: 0;
            width: 4px; height: 100%;
            background: linear-gradient(to bottom, var(--accent-orange), var(--accent-yellow));
        }
        .card-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .card-title { font-size: 16px; font-weight: 700; flex: 1; }
        .card-cat {
            font-size: 11px; font-weight: 700;
            padding: 3px 10px; border-radius: 12px;
            text-transform: uppercase; letter-spacing: 0.5px;
            white-space: nowrap;
        }
        .card-stars { color: var(--accent-yellow); font-size: 14px; margin-bottom: 6px; letter-spacing: 2px; }
        .card-meta {
            display: flex; flex-wrap: wrap; gap: 10px;
            font-size: 12px; color: var(--text-muted);
        }
        .card-meta span { display: flex; align-items: center; gap: 4px; }
        .card-tags { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 8px; }
        .card-tag {
            padding: 2px 8px; border-radius: 8px;
            background: rgba(0,212,170,0.1);
            border: 1px solid rgba(0,212,170,0.2);
            font-size: 10px; font-weight: 600; color: var(--accent);
        }
        .card-photos {
            display: flex; gap: 6px; margin-top: 10px; overflow-x: auto;
            scrollbar-width: none;
        }
        .card-photos::-webkit-scrollbar { display: none; }
        .card-photo {
            width: 60px; height: 60px; border-radius: var(--radius-xs);
            object-fit: cover; flex-shrink: 0;
            border: 1px solid var(--border);
        }
        .card-actions {
            display: flex; gap: 6px; margin-top: 10px;
        }
        .card-action-btn {
            padding: 6px 12px;
            border-radius: var(--radius-xs);
            border: 1px solid var(--border);
            background: var(--bg-elevated);
            color: var(--text-secondary);
            font-family: inherit; font-size: 12px; font-weight: 600;
            cursor: pointer; transition: var(--transition-fast);
            display: flex; align-items: center; gap: 4px;
        }
        .card-action-btn:hover { border-color: var(--accent); color: var(--accent); }

        .empty-state {
            text-align: center; padding: 60px 20px;
            color: var(--text-muted);
        }
        .empty-state .empty-icon { font-size: 64px; margin-bottom: 16px; }
        .empty-state h3 { font-size: 18px; color: var(--text-secondary); margin-bottom: 8px; }
        .empty-state p { font-size: 14px; line-height: 1.6; }

        /* ===== STATS ===== */
        .stat-grid {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;
            margin-bottom: 24px;
        }
        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px; text-align: center;
        }
        .stat-value {
            font-size: 32px; font-weight: 900;
            background: linear-gradient(135deg, var(--accent), var(--accent-blue));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .stat-label {
            font-size: 12px; font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 0.5px;
            margin-top: 4px;
        }
        .stat-section {
            margin-bottom: 24px;
        }
        .stat-section h3 {
            font-size: 15px; font-weight: 700;
            color: var(--text-secondary);
            margin-bottom: 12px;
            display: flex; align-items: center; gap: 8px;
        }
        .stat-bar-wrap {
            margin-bottom: 10px;
        }
        .stat-bar-label {
            display: flex; justify-content: space-between;
            font-size: 13px; margin-bottom: 4px;
        }
        .stat-bar-label .name { font-weight: 600; }
        .stat-bar-label .value { color: var(--text-muted); }
        .stat-bar {
            height: 8px; border-radius: 4px;
            background: var(--bg-elevated);
            overflow: hidden;
        }
        .stat-bar-fill {
            height: 100%; border-radius: 4px;
            background: linear-gradient(90deg, var(--accent), var(--accent-blue));
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .chart-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px; margin-bottom: 16px;
        }
        .chart-row {
            display: flex; align-items: center; gap: 10px;
            margin-bottom: 10px;
        }
        .chart-icon { font-size: 20px; width: 30px; text-align: center; }
        .chart-bar-bg {
            flex: 1; height: 28px; background: var(--bg-elevated);
            border-radius: var(--radius-xs); overflow: hidden;
            position: relative;
        }
        .chart-bar-fg {
            height: 100%; border-radius: var(--radius-xs);
            display: flex; align-items: center; padding-left: 10px;
            font-size: 12px; font-weight: 700;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            min-width: fit-content;
        }
        .chart-count {
            font-size: 13px; font-weight: 700;
            color: var(--text-secondary);
            min-width: 28px; text-align: right;
        }

        /* ===== SETTINGS ===== */
        .setting-group {
            margin-bottom: 24px;
        }
        .setting-group h3 {
            font-size: 13px; font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 1px;
            margin-bottom: 12px;
        }
        .setting-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 14px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            margin-bottom: 8px;
        }
        .setting-info { flex: 1; }
        .setting-info .name { font-size: 14px; font-weight: 600; }
        .setting-info .desc { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
        .toggle {
            width: 50px; height: 28px;
            border-radius: 14px; border: none;
            background: var(--bg-elevated);
            position: relative; cursor: pointer;
            transition: var(--transition);
        }
        .toggle.on { background: var(--accent); }
        .toggle::after {
            content: '';
            position: absolute; top: 3px; left: 3px;
            width: 22px; height: 22px;
            border-radius: 50%;
            background: #fff;
            transition: var(--transition);
        }
        .toggle.on::after { left: 25px; }
        .setting-btn {
            width: 100%; padding: 14px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-primary);
            font-family: inherit; font-size: 14px; font-weight: 600;
            cursor: pointer; transition: var(--transition);
            display: flex; align-items: center; justify-content: center; gap: 8px;
            margin-bottom: 8px;
        }
        .setting-btn:hover { background: var(--bg-card-hover); border-color: var(--accent); }
        .setting-btn.danger { border-color: rgba(255,107,107,0.3); color: var(--accent-secondary); }
        .setting-btn.danger:hover { background: rgba(255,107,107,0.1); }

        /* Map Style Picker */
        .map-style-grid {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;
        }
        .map-style-option {
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--bg-card);
            text-align: center;
            cursor: pointer; transition: var(--transition);
            font-size: 13px; font-weight: 600;
        }
        .map-style-option .style-icon { font-size: 28px; display: block; margin-bottom: 4px; }
        .map-style-option:hover { background: var(--bg-card-hover); }
        .map-style-option.selected { border-color: var(--accent); background: rgba(0,212,170,0.1); }

        /* ===== DETAIL VIEW ===== */
        .detail-hero {
            position: relative; height: 200px;
            background: var(--bg-card);
            overflow: hidden;
        }
        .detail-hero img {
            width: 100%; height: 100%; object-fit: cover;
        }
        .detail-hero-placeholder {
            width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            font-size: 64px;
            background: linear-gradient(135deg, var(--bg-card), var(--bg-elevated));
        }
        .detail-hero-overlay {
            position: absolute; bottom: 0; left: 0; right: 0;
            padding: 16px 20px;
            background: linear-gradient(transparent, rgba(15,25,35,0.95));
        }
        .detail-hero-overlay h2 { font-size: 22px; font-weight: 800; }
        .detail-body { padding: 20px; }
        .detail-badges {
            display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px;
        }
        .detail-badge {
            padding: 5px 12px; border-radius: 16px;
            font-size: 12px; font-weight: 700;
            display: flex; align-items: center; gap: 5px;
        }
        .detail-section {
            margin-bottom: 20px;
        }
        .detail-section h3 {
            font-size: 13px; font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        .detail-notes {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 14px;
            font-size: 14px; line-height: 1.6;
            color: var(--text-secondary);
        }
        .detail-actions {
            display: flex; gap: 8px; flex-wrap: wrap;
        }
        .detail-photo-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;
        }
        .detail-photo {
            aspect-ratio: 1; border-radius: var(--radius-sm);
            object-fit: cover; border: 1px solid var(--border);
            cursor: pointer; transition: var(--transition);
            width: 100%;
        }
        .detail-photo:hover { transform: scale(1.03); border-color: var(--accent); }

        /* ===== PHOTO VIEWER ===== */
        .photo-viewer {
            position: fixed; inset: 0;
            z-index: 5000;
            background: rgba(0,0,0,0.95);
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none;
            transition: opacity 0.3s;
        }
        .photo-viewer.open { opacity: 1; pointer-events: auto; }
        .photo-viewer img { max-width: 95%; max-height: 90vh; object-fit: contain; border-radius: var(--radius-sm); }
        .photo-viewer-close {
            position: absolute; top: 16px; right: 16px;
            width: 44px; height: 44px; border-radius: 50%;
            background: rgba(255,255,255,0.15);
            border: none; color: #fff; font-size: 24px;
            cursor: pointer; display: flex;
            align-items: center; justify-content: center;
        }

        /* ===== TOAST ===== */
        .toast-container {
            position: fixed; top: 80px; left: 50%; transform: translateX(-50%);
            z-index: 9999; display: flex; flex-direction: column;
            gap: 8px; align-items: center;
        }
        .toast {
            padding: 12px 20px;
            border-radius: var(--radius-sm);
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            color: var(--text-primary);
            font-size: 14px; font-weight: 600;
            box-shadow: var(--shadow);
            animation: toast-in 0.3s ease, toast-out 0.3s ease 2.5s forwards;
            display: flex; align-items: center; gap: 8px;
        }
        .toast.success { border-color: var(--accent); }
        .toast.error { border-color: var(--accent-secondary); }
        @keyframes toast-in { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes toast-out { from { opacity: 1; } to { opacity: 0; transform: translateY(-10px); } }

        /* ===== CONFIRM DIALOG ===== */
        .confirm-overlay {
            position: fixed; inset: 0; z-index: 6000;
            background: rgba(0,0,0,0.7);
            display: flex; align-items: center; justify-content: center;
            padding: 20px;
            opacity: 0; pointer-events: none;
            transition: opacity 0.3s;
        }
        .confirm-overlay.open { opacity: 1; pointer-events: auto; }
        .confirm-box {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 24px; max-width: 340px; width: 100%;
            text-align: center;
        }
        .confirm-box h3 { font-size: 18px; margin-bottom: 8px; }
        .confirm-box p { font-size: 14px; color: var(--text-secondary); margin-bottom: 20px; line-height: 1.5; }
        .confirm-actions { display: flex; gap: 10px; }

        /* ===== MAP LAYER STYLES ===== */
        .leaflet-popup-content-wrapper {
            background: var(--bg-card) !important;
            color: var(--text-primary) !important;
            border-radius: var(--radius-sm) !important;
            border: 1px solid var(--border) !important;
            box-shadow: var(--shadow) !important;
        }
        .leaflet-popup-tip { background: var(--bg-card) !important; }
        .leaflet-popup-content { margin: 12px !important; font-family: 'Nunito', sans-serif !important; }
        .popup-title { font-weight: 700; font-size: 15px; margin-bottom: 4px; }
        .popup-cat { font-size: 12px; color: var(--text-muted); margin-bottom: 6px; }
        .popup-stars { color: var(--accent-yellow); font-size: 14px; letter-spacing: 1px; }
        .popup-actions { display: flex; gap: 6px; margin-top: 8px; }
        .popup-btn {
            padding: 5px 10px; border-radius: var(--radius-xs);
            border: 1px solid var(--border);
            background: var(--bg-elevated);
            color: var(--text-primary);
            font-family: inherit; font-size: 11px; font-weight: 600;
            cursor: pointer;
        }
        .popup-btn:hover { border-color: var(--accent); color: var(--accent); }

        .marker-cluster-small, .marker-cluster-medium, .marker-cluster-large {
            background: rgba(0, 212, 170, 0.3) !important;
        }
        .marker-cluster-small div, .marker-cluster-medium div, .marker-cluster-large div {
            background: rgba(0, 212, 170, 0.7) !important;
            color: #fff !important;
            font-family: 'Nunito', sans-serif !important;
            font-weight: 800 !important;
        }

        /* ===== LEAFLET OVERRIDES ===== */
        .leaflet-control-zoom { border: 1px solid var(--border) !important; border-radius: var(--radius-sm) !important; overflow: hidden; }
        .leaflet-control-zoom a {
            background: rgba(15,25,35,0.9) !important;
            color: var(--text-primary) !important;
            border-color: var(--border) !important;
            width: 36px !important; height: 36px !important;
            line-height: 36px !important; font-size: 18px !important;
        }
        .leaflet-control-zoom a:hover { background: var(--bg-card-hover) !important; }

        /* ===== VISIT HISTORY ===== */
        .visit-list { list-style: none; }
        .visit-item {
            padding: 10px 14px;
            border-left: 3px solid var(--accent);
            margin-bottom: 8px;
            background: var(--bg-card);
            border-radius: 0 var(--radius-xs) var(--radius-xs) 0;
            display: flex; justify-content: space-between; align-items: center;
        }
        .visit-date { font-size: 14px; font-weight: 600; }
        .visit-note { font-size: 12px; color: var(--text-muted); }
        .add-visit-btn {
            width: 100%; padding: 10px;
            border: 2px dashed var(--border);
            border-radius: var(--radius-sm);
            background: none;
            color: var(--text-muted);
            font-family: inherit; font-size: 13px; font-weight: 600;
            cursor: pointer; transition: var(--transition);
            margin-top: 8px;
        }
        .add-visit-btn:hover { border-color: var(--accent); color: var(--accent); }

        /* ===== ANIMATIONS ===== */
        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fade-in 0.4s ease both; }
        .delay-1 { animation-delay: 0.05s; }
        .delay-2 { animation-delay: 0.1s; }
        .delay-3 { animation-delay: 0.15s; }
        .delay-4 { animation-delay: 0.2s; }

        /* ===== RESPONSIVE ===== */
        @media (min-width: 600px) {
            .stat-grid { grid-template-columns: repeat(4, 1fr); }
            .category-grid { grid-template-columns: repeat(4, 1fr); }
        }

        /* ===== FORMULAR-VALIDIERUNG ===== */
        .form-hint {
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }
        .form-hint.error { color: var(--accent-secondary); }
        .form-input.input-error {
            border-color: var(--accent-secondary) !important;
            box-shadow: 0 0 0 3px var(--accent-secondary-glow) !important;
        }
    </style>
</head>
<body>

<div class="bg-glow bg-glow-1"></div>
<div class="bg-glow bg-glow-2"></div>

<!-- ===== HEADER ===== -->
<header class="header">
    <div class="header-left">
        <span class="header-logo">üó∫Ô∏è</span>
        <span class="header-title">Magdeburg Freizeit</span>
    </div>
    <div class="header-right">
        <button class="header-btn" id="searchToggle" title="Suche">üîç</button>
        <button class="header-btn" id="layerToggle" title="Kartenstil">üó∫Ô∏è</button>
    </div>
</header>

<!-- ===== SEARCH BAR ===== -->
<div class="search-bar" id="searchBar">
    <div class="search-input-wrap">
        <span class="icon">üîç</span>
        <input type="text" class="search-input" id="searchInput" placeholder="Orte durchsuchen...">
        <button class="search-clear" id="searchClear">&times;</button>
    </div>
</div>

<!-- ===== CATEGORY CHIPS ===== -->
<div class="category-bar" id="categoryBar">
    <button class="chip active" data-filter="all">üìç Alle <span class="count" id="countAll">0</span></button>
    <button class="chip" data-filter="spielplatz">üé† Spielplatz <span class="count" id="countSpielplatz">0</span></button>
    <button class="chip" data-filter="attraktion">üé™ Attraktion <span class="count" id="countAttraktion">0</span></button>
    <button class="chip" data-filter="restaurant">üçΩÔ∏è Restaurant <span class="count" id="countRestaurant">0</span></button>
    <button class="chip" data-filter="park">üå≥ Park <span class="count" id="countPark">0</span></button>
    <button class="chip" data-filter="museum">üèõÔ∏è Museum <span class="count" id="countMuseum">0</span></button>
    <button class="chip" data-filter="schwimmbad">üèä Schwimmbad <span class="count" id="countSchwimmbad">0</span></button>
    <button class="chip" data-filter="sport">‚öΩ Sport <span class="count" id="countSport">0</span></button>
    <button class="chip" data-filter="sonstiges">üìå Sonstiges <span class="count" id="countSonstiges">0</span></button>
    <button class="chip" data-filter="favoriten">‚ù§Ô∏è Favoriten <span class="count" id="countFavoriten">0</span></button>
    <button class="chip" data-filter="wishlist">üéØ Merkliste <span class="count" id="countWishlist">0</span></button>
</div>

<!-- ===== MAP ===== -->
<div id="map"></div>

<!-- ===== MAP CONTROLS ===== -->
<div class="map-controls">
    <button class="map-ctrl-btn" id="locateBtn" title="Mein Standort">üìç</button>
    <button class="map-ctrl-btn" id="fitAllBtn" title="Alle anzeigen">üî≤</button>
</div>

<!-- ===== FAB ===== -->
<button class="fab" id="addFab" title="Neuen Ort hinzuf√ºgen">+</button>

<!-- ===== BOTTOM NAV ===== -->
<nav class="bottom-nav">
    <button class="nav-item active" data-view="map">
        <span class="nav-icon">üó∫Ô∏è</span>
        <span>Karte</span>
    </button>
    <button class="nav-item" data-view="list">
        <span class="nav-icon">üìã</span>
        <span>Liste</span>
        <span class="nav-badge" id="listBadge" style="display:none">0</span>
    </button>
    <button class="nav-item" data-view="stats">
        <span class="nav-icon">üìä</span>
        <span>Statistik</span>
    </button>
    <button class="nav-item" data-view="settings">
        <span class="nav-icon">‚öôÔ∏è</span>
        <span>Mehr</span>
    </button>
</nav>

<!-- ===== ADD/EDIT MODAL ===== -->
<div class="modal-overlay" id="modalOverlay"></div>
<div class="modal" id="locationModal">
    <div class="modal-handle"></div>
    <div class="modal-header">
        <h2 id="modalTitle">Neuer Ort</h2>
        <button class="panel-close" id="modalClose">&times;</button>
    </div>
    <div class="modal-body">
        <form id="locationForm">
            <input type="hidden" id="fId">
            <input type="hidden" id="fLat">
            <input type="hidden" id="fLng">

            <div class="form-group">
                <label>Name des Ortes *</label>
                <input type="text" class="form-input" id="fName" required placeholder="z.B. Elbauenpark">
            </div>

            <div class="form-group">
                <label>Kategorie *</label>
                <div class="category-grid" id="catGrid">
                    <div class="cat-option" data-cat="spielplatz"><span class="cat-icon">üé†</span>Spielplatz</div>
                    <div class="cat-option" data-cat="attraktion"><span class="cat-icon">üé™</span>Attraktion</div>
                    <div class="cat-option" data-cat="restaurant"><span class="cat-icon">üçΩÔ∏è</span>Restaurant</div>
                    <div class="cat-option" data-cat="park"><span class="cat-icon">üå≥</span>Park</div>
                    <div class="cat-option" data-cat="museum"><span class="cat-icon">üèõÔ∏è</span>Museum</div>
                    <div class="cat-option" data-cat="schwimmbad"><span class="cat-icon">üèä</span>Schwimmbad</div>
                    <div class="cat-option" data-cat="sport"><span class="cat-icon">‚öΩ</span>Sport</div>
                    <div class="cat-option" data-cat="sonstiges"><span class="cat-icon">üìå</span>Sonstiges</div>
                </div>
            </div>

            <div class="form-group">
                <label>Bewertung</label>
                <div class="star-rating">
                    <input type="radio" name="rating" id="star5" value="5"><label for="star5">‚òÖ</label>
                    <input type="radio" name="rating" id="star4" value="4"><label for="star4">‚òÖ</label>
                    <input type="radio" name="rating" id="star3" value="3"><label for="star3">‚òÖ</label>
                    <input type="radio" name="rating" id="star2" value="2"><label for="star2">‚òÖ</label>
                    <input type="radio" name="rating" id="star1" value="1"><label for="star1">‚òÖ</label>
                </div>
            </div>

            <div class="form-group">
                <label>Status</label>
                <div class="status-toggle">
                    <button type="button" class="status-btn active-visited" data-status="visited" id="statusVisited">‚úÖ Besucht</button>
                    <button type="button" class="status-btn" data-status="wishlist" id="statusWishlist">üéØ Merkliste</button>
                    <button type="button" class="status-btn" data-status="favorite" id="statusFavorite">‚ù§Ô∏è Favorit</button>
                </div>
            </div>

            <div class="form-group">
                <label>Letzter Besuch</label>
                <input type="date" class="form-input" id="fDate">
            </div>

            <div class="form-group">
                <label>Notizen</label>
                <textarea class="form-textarea" id="fNotes" placeholder="Deine Eindr√ºcke, Tipps..."></textarea>
            </div>

            <div class="form-group">
                <label>Tags</label>
                <div class="tags-input-wrap" id="tagsWrap">
                    <input type="text" class="tag-input" id="tagInput" placeholder="Tag eingeben + Enter">
                </div>
                <div class="tag-suggestions" id="tagSuggestions">
                    <span class="tag-sug" data-tag="kinderfreundlich">kinderfreundlich</span>
                    <span class="tag-sug" data-tag="kostenlos">kostenlos</span>
                    <span class="tag-sug" data-tag="barrierefrei">barrierefrei</span>
                    <span class="tag-sug" data-tag="parkplatz">parkplatz</span>
                    <span class="tag-sug" data-tag="indoor">indoor</span>
                    <span class="tag-sug" data-tag="outdoor">outdoor</span>
                    <span class="tag-sug" data-tag="gastronomie">gastronomie</span>
                    <span class="tag-sug" data-tag="schatten">schatten</span>
                    <span class="tag-sug" data-tag="wasserspiel">wasserspiel</span>
                    <span class="tag-sug" data-tag="ruhig">ruhig</span>
                </div>
            </div>

            <div class="form-group">
                <label>Fotos</label>
                <div class="photo-upload" id="photoUpload">
                    <input type="file" accept="image/*" multiple id="photoInput">
                    <div class="upload-icon">üì∑</div>
                    <div class="upload-text">Tippe zum Foto hochladen</div>
                </div>
                <div class="photo-preview" id="photoPreview"></div>
            </div>

            <div class="form-group">
                <label>Google Maps Link (optional)</label>
                <input type="url" class="form-input" id="fMapsLink" placeholder="https://maps.google.com/...">
                <div class="form-hint error" id="mapsLinkHint">Ung√ºltige URL ‚Äì muss mit https:// oder http:// beginnen</div>
            </div>

            <div class="form-group">
                <label>Webseite (optional)</label>
                <input type="url" class="form-input" id="fWebsite" placeholder="https://...">
                <div class="form-hint error" id="websiteHint">Ung√ºltige URL ‚Äì muss mit https:// oder http:// beginnen</div>
            </div>

            <div class="form-actions">
                <button type="button" class="btn btn-secondary" id="modalCancelBtn">Abbrechen</button>
                <button type="submit" class="btn btn-primary" id="saveBtn">üíæ Speichern</button>
            </div>
        </form>
    </div>
</div>

<!-- ===== LIST PANEL ===== -->
<div class="panel" id="listPanel">
    <div class="panel-header">
        <h2>üìã Alle Orte</h2>
        <button class="panel-close" id="listClose">&times;</button>
    </div>
    <div class="panel-body">
        <div class="list-sort" id="listSort">
            <button class="sort-btn active" data-sort="name">A‚ÄìZ</button>
            <button class="sort-btn" data-sort="rating">‚≠ê Bewertung</button>
            <button class="sort-btn" data-sort="date">üìÖ Datum</button>
            <button class="sort-btn" data-sort="category">üìÇ Kategorie</button>
            <button class="sort-btn" data-sort="visits">üë£ Besuche</button>
        </div>
        <div id="listContent"></div>
    </div>
</div>

<!-- ===== STATS PANEL ===== -->
<div class="panel" id="statsPanel">
    <div class="panel-header">
        <h2>üìä Statistiken</h2>
        <button class="panel-close" id="statsClose">&times;</button>
    </div>
    <div class="panel-body" id="statsContent"></div>
</div>

<!-- ===== SETTINGS PANEL ===== -->
<div class="panel" id="settingsPanel">
    <div class="panel-header">
        <h2>‚öôÔ∏è Einstellungen</h2>
        <button class="panel-close" id="settingsClose">&times;</button>
    </div>
    <div class="panel-body" id="settingsContent"></div>
</div>

<!-- ===== DETAIL PANEL ===== -->
<div class="panel" id="detailPanel">
    <div class="panel-header">
        <h2 id="detailTitle">Details</h2>
        <button class="panel-close" id="detailClose">&times;</button>
    </div>
    <div id="detailContent"></div>
</div>

<!-- ===== PHOTO VIEWER ===== -->
<div class="photo-viewer" id="photoViewer">
    <button class="photo-viewer-close" id="photoViewerClose">&times;</button>
    <img id="photoViewerImg" src="" alt="Foto">
</div>

<!-- ===== TOAST CONTAINER ===== -->
<div class="toast-container" id="toastContainer"></div>

<!-- ===== CONFIRM DIALOG ===== -->
<div class="confirm-overlay" id="confirmOverlay">
    <div class="confirm-box">
        <h3 id="confirmTitle">Best√§tigen</h3>
        <p id="confirmMsg">Bist du sicher?</p>
        <div class="confirm-actions">
            <button class="btn btn-secondary" id="confirmNo">Abbrechen</button>
            <button class="btn btn-danger" id="confirmYes">L√∂schen</button>
        </div>
    </div>
</div>

<!-- ===== SCRIPTS ===== -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script>
// ===========================================================================================
// MAGDEBURG FREIZEITKARTE ‚Äì VOLLST√ÑNDIGE APP-LOGIK
// ===========================================================================================

(function() {
'use strict';

// ===== KONFIGURATION =====
const CATEGORIES = {
    spielplatz:  { icon: 'üé†', label: 'Spielplatz', color: '#00d4aa', bgColor: 'rgba(0,212,170,0.15)' },
    attraktion:  { icon: 'üé™', label: 'Attraktion', color: '#4facfe', bgColor: 'rgba(79,172,254,0.15)' },
    restaurant:  { icon: 'üçΩÔ∏è', label: 'Restaurant', color: '#ff6b6b', bgColor: 'rgba(255,107,107,0.15)' },
    park:        { icon: 'üå≥', label: 'Park', color: '#66bb6a', bgColor: 'rgba(102,187,106,0.15)' },
    museum:      { icon: 'üèõÔ∏è', label: 'Museum', color: '#b388ff', bgColor: 'rgba(179,136,255,0.15)' },
    schwimmbad:  { icon: 'üèä', label: 'Schwimmbad', color: '#29b6f6', bgColor: 'rgba(41,182,246,0.15)' },
    sport:       { icon: '‚öΩ', label: 'Sport', color: '#ffa726', bgColor: 'rgba(255,167,38,0.15)' },
    sonstiges:   { icon: 'üìå', label: 'Sonstiges', color: '#8ba4be', bgColor: 'rgba(139,164,190,0.15)' }
};

const MAP_STYLES = {
    standard: { name: 'Standard', icon: 'üó∫Ô∏è', url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', attr: '¬© OpenStreetMap' },
    topo: { name: 'Topografisch', icon: '‚õ∞Ô∏è', url: 'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', attr: '¬© OpenTopoMap' },
    dark: { name: 'Dunkel', icon: 'üåô', url: 'https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.png', attr: '¬© Stadia Maps' },
    satellite: { name: 'Satellit', icon: 'üõ∞Ô∏è', url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', attr: '¬© Esri' }
};

const MAGDEBURG = [52.1205, 11.6276];
const DEFAULT_ZOOM = 13;

// ===== STATE =====
let db = null;
let map = null;
let tileLayer = null;
let markerCluster = null;
let markers = {};
let tempMarker = null;
let locations = [];
let currentFilter = 'all';
let currentSort = 'name';
let searchQuery = '';
let selectedCategory = '';
let currentTags = [];
let currentPhotos = [];
let editingId = null;
let currentLocationId = null;
let userPosition = null;
let settings = {
    mapStyle: 'standard',
    clusterMarkers: true,
    confirmDelete: true,
    showVisitCount: true,
    defaultCategory: '',
    autoLocate: false
};

// ===== INDEXEDDB =====
function openDB() {
    return new Promise((resolve, reject) => {
        const req = indexedDB.open('MagdeburgFreizeit', 3);
        req.onupgradeneeded = (e) => {
            const db = e.target.result;
            if (!db.objectStoreNames.contains('locations')) {
                const store = db.createObjectStore('locations', { keyPath: 'id' });
                store.createIndex('category', 'category', { unique: false });
                store.createIndex('rating', 'rating', { unique: false });
            }
            if (!db.objectStoreNames.contains('settings')) {
                db.createObjectStore('settings', { keyPath: 'key' });
            }
        };
        req.onsuccess = (e) => { db = e.target.result; resolve(db); };
        req.onerror = (e) => reject(e.target.error);
    });
}

function dbTransaction(store, mode) {
    return db.transaction(store, mode).objectStore(store);
}

function dbGetAll(storeName) {
    return new Promise((resolve, reject) => {
        const req = dbTransaction(storeName, 'readonly').getAll();
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
    });
}

function dbPut(storeName, data) {
    return new Promise((resolve, reject) => {
        const req = dbTransaction(storeName, 'readwrite').put(data);
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
    });
}

function dbDelete(storeName, id) {
    return new Promise((resolve, reject) => {
        const req = dbTransaction(storeName, 'readwrite').delete(id);
        req.onsuccess = () => resolve();
        req.onerror = () => reject(req.error);
    });
}

// ===== MAP SETUP =====
function initMap() {
    map = L.map('map', {
        center: MAGDEBURG,
        zoom: DEFAULT_ZOOM,
        zoomControl: true,
        attributionControl: false
    });

    setMapStyle(settings.mapStyle);

    markerCluster = L.markerClusterGroup({
        maxClusterRadius: 50,
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
        disableClusteringAtZoom: 16
    });
    map.addLayer(markerCluster);

    // Klick auf Karte ‚Üí tempor√§rer Marker
    map.on('click', (e) => {
        if (tempMarker) map.removeLayer(tempMarker);
        tempMarker = L.marker(e.latlng, {
            icon: createIcon('üìç', '#888'),
            opacity: 0.7
        }).addTo(map);
        tempMarker.bindPopup(`
            <div style="text-align:center; font-family:Nunito,sans-serif">
                <b style="font-size:14px">Neuer Ort hier?</b><br>
                <button onclick="window.APP.openModalAt(${e.latlng.lat}, ${e.latlng.lng})"
                    style="margin-top:8px; padding:6px 16px; border:none; border-radius:8px;
                    background:linear-gradient(135deg,#00d4aa,#00b894); color:#fff;
                    font-family:Nunito; font-weight:700; cursor:pointer; font-size:13px">
                    ‚úö Hinzuf√ºgen
                </button>
            </div>
        `).openPopup();
    });
}

function setMapStyle(styleKey) {
    if (tileLayer) map.removeLayer(tileLayer);
    const style = MAP_STYLES[styleKey] || MAP_STYLES.standard;
    tileLayer = L.tileLayer(style.url, {
        attribution: style.attr,
        maxZoom: 19
    }).addTo(map);
    settings.mapStyle = styleKey;
    saveSettings();
}

function createIcon(emoji, color) {
    return L.divIcon({
        className: '',
        html: `<div style="
            width:40px; height:40px; border-radius:50%;
            background:${color || '#00d4aa'};
            border:3px solid #fff;
            display:flex; align-items:center; justify-content:center;
            font-size:20px; box-shadow: 0 3px 12px rgba(0,0,0,0.4);
            transform: translate(-20px, -20px);
        ">${emoji}</div>`,
        iconSize: [0, 0]
    });
}

function createMarkerForLocation(loc) {
    const cat = CATEGORIES[loc.category] || CATEGORIES.sonstiges;
    const marker = L.marker([loc.lat, loc.lng], {
        icon: createIcon(cat.icon, loc.favorite ? '#ff6b6b' : cat.color)
    });

    const stars = '‚òÖ'.repeat(loc.rating || 0) + '‚òÜ'.repeat(5 - (loc.rating || 0));

    marker.bindPopup(`
        <div style="font-family:Nunito,sans-serif; min-width:180px">
            <div class="popup-title">${escHtml(loc.name)}</div>
            <div class="popup-cat">${cat.icon} ${cat.label}${loc.favorite ? ' ‚ù§Ô∏è' : ''}${loc.status === 'wishlist' ? ' üéØ' : ''}</div>
            <div class="popup-stars">${stars}</div>
            ${loc.lastVisit ? `<div style="font-size:11px; color:#8ba4be; margin-top:4px">üìÖ ${formatDate(loc.lastVisit)}</div>` : ''}
            ${loc.visitCount > 0 ? `<div style="font-size:11px; color:#8ba4be">üë£ ${loc.visitCount}√ó besucht</div>` : ''}
            <div class="popup-actions">
                <button class="popup-btn" onclick="window.APP.showDetail('${loc.id}')">Details</button>
                <button class="popup-btn" onclick="window.APP.editLocation('${loc.id}')">‚úèÔ∏è</button>
                ${sanitizeUrl(loc.mapsLink) ? `<a class="popup-btn" href="${sanitizeUrl(loc.mapsLink)}" target="_blank" rel="noopener" style="text-decoration:none">üó∫Ô∏è</a>` : ''}
            </div>
        </div>
    `);

    return marker;
}

function refreshMarkers() {
    markerCluster.clearLayers();
    markers = {};
    const filtered = getFilteredLocations();
    filtered.forEach(loc => {
        const m = createMarkerForLocation(loc);
        markers[loc.id] = m;
        if (settings.clusterMarkers) {
            markerCluster.addLayer(m);
        } else {
            m.addTo(map);
        }
    });
    updateCounts();
}

function fitBounds() {
    const filtered = getFilteredLocations();
    if (filtered.length === 0) {
        map.setView(MAGDEBURG, DEFAULT_ZOOM);
        return;
    }
    const bounds = L.latLngBounds(filtered.map(l => [l.lat, l.lng]));
    map.fitBounds(bounds, { padding: [50, 50], maxZoom: 15 });
}

// ===== FILTERING & SEARCH =====
function getFilteredLocations() {
    let result = [...locations];

    // Category filter
    if (currentFilter === 'favoriten') {
        result = result.filter(l => l.favorite);
    } else if (currentFilter === 'wishlist') {
        result = result.filter(l => l.status === 'wishlist');
    } else if (currentFilter !== 'all') {
        result = result.filter(l => l.category === currentFilter);
    }

    // Search
    if (searchQuery) {
        const q = searchQuery.toLowerCase();
        result = result.filter(l =>
            l.name.toLowerCase().includes(q) ||
            (l.notes && l.notes.toLowerCase().includes(q)) ||
            (l.tags && l.tags.some(t => t.toLowerCase().includes(q)))
        );
    }

    return result;
}

function sortLocations(locs, sortBy) {
    return [...locs].sort((a, b) => {
        switch (sortBy) {
            case 'name': return a.name.localeCompare(b.name, 'de');
            case 'rating': return (b.rating || 0) - (a.rating || 0);
            case 'date': return (b.lastVisit || '').localeCompare(a.lastVisit || '');
            case 'category': return (a.category || '').localeCompare(b.category || '');
            case 'visits': return (b.visitCount || 0) - (a.visitCount || 0);
            default: return 0;
        }
    });
}

function updateCounts() {
    const getId = (cat) => document.getElementById('count' + cat.charAt(0).toUpperCase() + cat.slice(1));
    document.getElementById('countAll').textContent = locations.length;
    Object.keys(CATEGORIES).forEach(key => {
        const el = getId(key);
        if (el) el.textContent = locations.filter(l => l.category === key).length;
    });
    document.getElementById('countFavoriten').textContent = locations.filter(l => l.favorite).length;
    document.getElementById('countWishlist').textContent = locations.filter(l => l.status === 'wishlist').length;

    // List badge
    const badge = document.getElementById('listBadge');
    badge.textContent = locations.length;
    badge.style.display = locations.length > 0 ? 'block' : 'none';
}

// ===== MODAL (ADD/EDIT) =====
function openModal(lat, lng, locData) {
    editingId = locData ? locData.id : null;
    document.getElementById('modalTitle').textContent = locData ? 'Ort bearbeiten' : 'Neuer Ort';

    // Reset
    document.getElementById('fId').value = editingId || '';
    document.getElementById('fLat').value = lat || '';
    document.getElementById('fLng').value = lng || '';
    document.getElementById('fName').value = locData ? locData.name : '';
    document.getElementById('fDate').value = locData ? (locData.lastVisit || '') : new Date().toISOString().split('T')[0];
    document.getElementById('fNotes').value = locData ? (locData.notes || '') : '';
    document.getElementById('fMapsLink').value = locData ? (locData.mapsLink || '') : '';
    document.getElementById('fWebsite').value = locData ? (locData.website || '') : '';

    // Validierungsfehler zur√ºcksetzen
    clearUrlError('fMapsLink', 'mapsLinkHint');
    clearUrlError('fWebsite', 'websiteHint');

    // Category
    selectedCategory = locData ? locData.category : (settings.defaultCategory || '');
    document.querySelectorAll('.cat-option').forEach(el => {
        el.classList.toggle('selected', el.dataset.cat === selectedCategory);
    });

    // Rating
    document.querySelectorAll('.star-rating input').forEach(el => {
        el.checked = locData && parseInt(el.value) === locData.rating;
    });

    // Status
    const status = locData ? (locData.status || 'visited') : 'visited';
    const fav = locData ? !!locData.favorite : false;
    updateStatusButtons(status, fav);

    // Tags
    currentTags = locData && locData.tags ? [...locData.tags] : [];
    renderTags();

    // Photos
    currentPhotos = locData && locData.photos ? [...locData.photos] : [];
    renderPhotoPreview();

    document.getElementById('modalOverlay').classList.add('open');
    document.getElementById('locationModal').classList.add('open');
    document.getElementById('fName').focus();
}

function closeModal() {
    document.getElementById('modalOverlay').classList.remove('open');
    document.getElementById('locationModal').classList.remove('open');
    if (tempMarker) { map.removeLayer(tempMarker); tempMarker = null; }
}

function updateStatusButtons(status, favorite) {
    const visited = document.getElementById('statusVisited');
    const wishlist = document.getElementById('statusWishlist');
    const fav = document.getElementById('statusFavorite');

    visited.className = 'status-btn' + (status === 'visited' ? ' active-visited' : '');
    wishlist.className = 'status-btn' + (status === 'wishlist' ? ' active-wishlist' : '');
    fav.className = 'status-btn' + (favorite ? ' active-favorite' : '');
}

async function saveLocation(e) {
    e.preventDefault();

    const lat = parseFloat(document.getElementById('fLat').value);
    const lng = parseFloat(document.getElementById('fLng').value);

    if (!lat || !lng) {
        toast('Bitte erst auf die Karte tippen um eine Position zu w√§hlen', 'error');
        return;
    }

    if (!selectedCategory) {
        toast('Bitte w√§hle eine Kategorie', 'error');
        return;
    }

    const name = document.getElementById('fName').value.trim();
    if (!name) {
        toast('Bitte gib einen Namen ein', 'error');
        return;
    }

    const mapsLink = document.getElementById('fMapsLink').value.trim();
    const website = document.getElementById('fWebsite').value.trim();

    if (mapsLink && !isValidUrl(mapsLink)) {
        showUrlError('fMapsLink', 'mapsLinkHint');
        toast('‚ùå Ung√ºltige Google Maps URL ‚Äì bitte https:// oder http:// verwenden', 'error');
        return;
    }
    if (website && !isValidUrl(website)) {
        showUrlError('fWebsite', 'websiteHint');
        toast('‚ùå Ung√ºltige Webseiten-URL ‚Äì bitte https:// oder http:// verwenden', 'error');
        return;
    }

    const ratingEl = document.querySelector('.star-rating input:checked');
    const isVisited = document.getElementById('statusVisited').classList.contains('active-visited');
    const isWishlist = document.getElementById('statusWishlist').classList.contains('active-wishlist');
    const isFavorite = document.getElementById('statusFavorite').classList.contains('active-favorite');

    const existing = editingId ? locations.find(l => l.id === editingId) : null;

    const locData = {
        id: editingId || 'loc_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6),
        name: name,
        category: selectedCategory,
        lat: lat,
        lng: lng,
        rating: ratingEl ? parseInt(ratingEl.value) : 0,
        status: isWishlist ? 'wishlist' : 'visited',
        favorite: isFavorite,
        lastVisit: document.getElementById('fDate').value || null,
        notes: document.getElementById('fNotes').value.trim() || null,
        tags: currentTags.length > 0 ? currentTags : null,
        photos: currentPhotos.length > 0 ? currentPhotos : null,
        mapsLink: mapsLink || null,
        website: website || null,
        visitCount: existing ? (existing.visitCount || 1) : 1,
        visits: existing ? (existing.visits || []) : [],
        createdAt: existing ? existing.createdAt : new Date().toISOString(),
        updatedAt: new Date().toISOString()
    };

    // Add initial visit if new and visited
    if (!existing && locData.status === 'visited' && locData.lastVisit) {
        locData.visits.push({ date: locData.lastVisit, note: '' });
    }

    await dbPut('locations', locData);
    await loadLocations();
    closeModal();
    refreshMarkers();
    toast(editingId ? '‚úÖ Ort aktualisiert' : '‚úÖ Ort gespeichert', 'success');
}

// ===== TAGS =====
function renderTags() {
    const wrap = document.getElementById('tagsWrap');
    const input = document.getElementById('tagInput');
    wrap.querySelectorAll('.tag').forEach(el => el.remove());
    currentTags.forEach((tag, i) => {
        const el = document.createElement('span');
        el.className = 'tag';
        el.innerHTML = `${escHtml(tag)} <button type="button" class="tag-remove" data-idx="${i}">&times;</button>`;
        wrap.insertBefore(el, input);
    });
}

function addTag(tag) {
    tag = tag.trim().toLowerCase();
    if (tag && !currentTags.includes(tag) && currentTags.length < 10) {
        currentTags.push(tag);
        renderTags();
    }
}

function removeTag(idx) {
    currentTags.splice(idx, 1);
    renderTags();
}

// ===== PHOTOS =====
function handlePhotoUpload(files) {
    Array.from(files).forEach(file => {
        if (currentPhotos.length >= 6) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            // Resize for storage
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const MAX = 800;
                let w = img.width, h = img.height;
                if (w > MAX || h > MAX) {
                    if (w > h) { h = h * MAX / w; w = MAX; }
                    else { w = w * MAX / h; h = MAX; }
                }
                canvas.width = w; canvas.height = h;
                canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                currentPhotos.push(canvas.toDataURL('image/jpeg', 0.7));
                renderPhotoPreview();
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    });
}

function renderPhotoPreview() {
    const container = document.getElementById('photoPreview');
    container.innerHTML = '';
    currentPhotos.forEach((photo, i) => {
        const wrap = document.createElement('div');
        wrap.className = 'photo-thumb-wrap';
        wrap.innerHTML = `
            <img class="photo-thumb" src="${photo}" alt="Foto ${i+1}">
            <button type="button" class="photo-remove" data-idx="${i}">&times;</button>
        `;
        container.appendChild(wrap);
    });
}

// ===== DETAIL VIEW =====
function showDetail(id) {
    const loc = locations.find(l => l.id === id);
    if (!loc) return;
    currentLocationId = id;

    const cat = CATEGORIES[loc.category] || CATEGORIES.sonstiges;
    const stars = '‚òÖ'.repeat(loc.rating || 0) + '‚òÜ'.repeat(5 - (loc.rating || 0));

    let html = '';

    // Hero
    if (loc.photos && loc.photos.length > 0) {
        html += `<div class="detail-hero"><img src="${loc.photos[0]}" alt="${escHtml(loc.name)}"></div>`;
    } else {
        html += `<div class="detail-hero"><div class="detail-hero-placeholder">${cat.icon}</div></div>`;
    }

    html += `<div class="detail-body">`;

    // Badges
    html += `<div class="detail-badges">
        <span class="detail-badge" style="background:${cat.bgColor}; color:${cat.color}; border:1px solid ${cat.color}40">${cat.icon} ${cat.label}</span>
        <span class="detail-badge" style="background:rgba(255,215,64,0.15); color:#ffd740; border:1px solid rgba(255,215,64,0.3)">${stars}</span>
        ${loc.favorite ? '<span class="detail-badge" style="background:rgba(255,107,107,0.15); color:#ff6b6b; border:1px solid rgba(255,107,107,0.3)">‚ù§Ô∏è Favorit</span>' : ''}
        ${loc.status === 'wishlist' ? '<span class="detail-badge" style="background:rgba(255,167,38,0.15); color:#ffa726; border:1px solid rgba(255,167,38,0.3)">üéØ Merkliste</span>' : ''}
    </div>`;

    // Info
    html += `<div class="detail-section"><h3>Informationen</h3>
        <div style="display:grid; gap:8px">
            ${loc.lastVisit ? `<div style="display:flex; align-items:center; gap:8px; font-size:14px">üìÖ Letzter Besuch: <strong>${formatDate(loc.lastVisit)}</strong></div>` : ''}
            <div style="display:flex; align-items:center; gap:8px; font-size:14px">üë£ Besuche: <strong>${loc.visitCount || 0}</strong></div>
            <div style="display:flex; align-items:center; gap:8px; font-size:14px">üìç Position: <strong>${loc.lat.toFixed(5)}, ${loc.lng.toFixed(5)}</strong></div>
            ${loc.createdAt ? `<div style="display:flex; align-items:center; gap:8px; font-size:14px">üïê Erstellt: <strong>${formatDate(loc.createdAt.split('T')[0])}</strong></div>` : ''}
        </div>
    </div>`;

    // Distance from current position
    if (userPosition) {
        const dist = getDistance(userPosition[0], userPosition[1], loc.lat, loc.lng);
        html += `<div class="detail-section">
            <div style="display:flex; align-items:center; gap:8px; font-size:14px; padding:10px 14px; background:var(--bg-card); border-radius:var(--radius-sm); border:1px solid var(--border)">
                üìè Entfernung: <strong>${dist < 1 ? (dist * 1000).toFixed(0) + ' m' : dist.toFixed(1) + ' km'}</strong>
            </div>
        </div>`;
    }

    // Notes
    if (loc.notes) {
        html += `<div class="detail-section"><h3>Notizen</h3>
            <div class="detail-notes">${escHtml(loc.notes).replace(/\n/g, '<br>')}</div>
        </div>`;
    }

    // Tags
    if (loc.tags && loc.tags.length > 0) {
        html += `<div class="detail-section"><h3>Tags</h3>
            <div style="display:flex; flex-wrap:wrap; gap:6px">
                ${loc.tags.map(t => `<span class="card-tag">${escHtml(t)}</span>`).join('')}
            </div>
        </div>`;
    }

    // Photos
    if (loc.photos && loc.photos.length > 0) {
        html += `<div class="detail-section"><h3>Fotos (${loc.photos.length})</h3>
            <div class="detail-photo-grid">
                ${loc.photos.map((p, i) => `<img class="detail-photo" src="${p}" alt="Foto" data-photo-idx="${i}" onclick="window.APP.viewPhoto('${id}', ${i})">`).join('')}
            </div>
        </div>`;
    }

    // Visit History
    html += `<div class="detail-section"><h3>Besuchshistorie</h3>`;
    if (loc.visits && loc.visits.length > 0) {
        html += `<ul class="visit-list">`;
        loc.visits.sort((a, b) => b.date.localeCompare(a.date)).forEach((v, i) => {
            html += `<li class="visit-item">
                <div><div class="visit-date">${formatDate(v.date)}</div>${v.note ? `<div class="visit-note">${escHtml(v.note)}</div>` : ''}</div>
            </li>`;
        });
        html += `</ul>`;
    }
    html += `<button class="add-visit-btn" onclick="window.APP.addVisit('${id}')">+ Besuch hinzuf√ºgen</button></div>`;

    // Links
    if (loc.mapsLink || loc.website) {
        html += `<div class="detail-section"><h3>Links</h3>
            <div style="display:flex; flex-direction:column; gap:8px">
                ${sanitizeUrl(loc.mapsLink) ? `<a href="${sanitizeUrl(loc.mapsLink)}" target="_blank" rel="noopener" class="card-action-btn" style="text-decoration:none; justify-content:center">üó∫Ô∏è Google Maps √∂ffnen</a>` : ''}
                ${sanitizeUrl(loc.website) ? `<a href="${sanitizeUrl(loc.website)}" target="_blank" rel="noopener" class="card-action-btn" style="text-decoration:none; justify-content:center">üåê Webseite √∂ffnen</a>` : ''}
            </div>
        </div>`;
    }

    // Actions
    html += `<div class="detail-section">
        <div class="detail-actions">
            <button class="btn btn-primary" style="flex:1" onclick="window.APP.editLocation('${id}')">‚úèÔ∏è Bearbeiten</button>
            <button class="btn btn-secondary" style="flex:0" onclick="window.APP.flyToLocation('${id}')">üìç Karte</button>
            <button class="btn btn-danger" style="flex:0" onclick="window.APP.confirmDelete('${id}')">üóëÔ∏è</button>
        </div>
    </div>`;

    // Share
    html += `<div class="detail-section">
        <button class="setting-btn" onclick="window.APP.shareLocation('${id}')">üì§ Teilen</button>
    </div>`;

    html += `</div>`;

    document.getElementById('detailTitle').textContent = loc.name;
    document.getElementById('detailContent').innerHTML = html;
    openPanel('detail');
}

function viewPhoto(locId, idx) {
    const loc = locations.find(l => l.id === locId);
    if (!loc || !loc.photos || !loc.photos[idx]) return;
    document.getElementById('photoViewerImg').src = loc.photos[idx];
    document.getElementById('photoViewer').classList.add('open');
}

async function addVisit(id) {
    const loc = locations.find(l => l.id === id);
    if (!loc) return;
    const today = new Date().toISOString().split('T')[0];
    if (!loc.visits) loc.visits = [];
    loc.visits.push({ date: today, note: '' });
    loc.visitCount = (loc.visitCount || 0) + 1;
    loc.lastVisit = today;
    loc.status = 'visited';
    await dbPut('locations', loc);
    await loadLocations();
    refreshMarkers();
    showDetail(id);
    toast('‚úÖ Besuch hinzugef√ºgt');
}

function shareLocation(id) {
    const loc = locations.find(l => l.id === id);
    if (!loc) return;
    const cat = CATEGORIES[loc.category] || CATEGORIES.sonstiges;
    const stars = '‚≠ê'.repeat(loc.rating || 0);
    const text = `${cat.icon} ${loc.name}\n${stars}\nüìç https://www.openstreetmap.org/?mlat=${loc.lat}&mlon=${loc.lng}#map=17/${loc.lat}/${loc.lng}`;

    if (navigator.share) {
        navigator.share({ title: loc.name, text: text }).catch(() => {});
    } else {
        navigator.clipboard.writeText(text).then(() => toast('üìã In Zwischenablage kopiert'));
    }
}

// ===== LIST VIEW =====
function renderList() {
    const filtered = sortLocations(getFilteredLocations(), currentSort);
    const container = document.getElementById('listContent');

    if (filtered.length === 0) {
        container.innerHTML = `<div class="empty-state">
            <div class="empty-icon">üó∫Ô∏è</div>
            <h3>Keine Orte gefunden</h3>
            <p>Tippe auf die Karte oder den + Button um deinen ersten Ort hinzuzuf√ºgen!</p>
        </div>`;
        return;
    }

    container.innerHTML = filtered.map((loc, i) => {
        const cat = CATEGORIES[loc.category] || CATEGORIES.sonstiges;
        const stars = '‚òÖ'.repeat(loc.rating || 0) + '‚òÜ'.repeat(5 - (loc.rating || 0));
        const cls = `location-card animate-in delay-${(i % 5) + 1}` +
            (loc.favorite ? ' favorite' : '') +
            (loc.status === 'wishlist' ? ' wishlist' : '');

        let dist = '';
        if (userPosition) {
            const d = getDistance(userPosition[0], userPosition[1], loc.lat, loc.lng);
            dist = `<span>üìè ${d < 1 ? (d * 1000).toFixed(0) + ' m' : d.toFixed(1) + ' km'}</span>`;
        }

        return `<div class="${cls}" onclick="window.APP.showDetail('${loc.id}')">
            <div class="card-top">
                <div class="card-title">${escHtml(loc.name)}</div>
                <span class="card-cat" style="background:${cat.bgColor}; color:${cat.color}">${cat.icon} ${cat.label}</span>
            </div>
            <div class="card-stars">${stars}</div>
            <div class="card-meta">
                ${loc.lastVisit ? `<span>üìÖ ${formatDate(loc.lastVisit)}</span>` : ''}
                ${loc.visitCount ? `<span>üë£ ${loc.visitCount}√ó</span>` : ''}
                ${dist}
                ${loc.favorite ? '<span>‚ù§Ô∏è</span>' : ''}
                ${loc.status === 'wishlist' ? '<span>üéØ</span>' : ''}
            </div>
            ${loc.tags && loc.tags.length > 0 ? `<div class="card-tags">${loc.tags.map(t => `<span class="card-tag">${escHtml(t)}</span>`).join('')}</div>` : ''}
            ${loc.photos && loc.photos.length > 0 ? `<div class="card-photos">${loc.photos.slice(0, 4).map(p => `<img class="card-photo" src="${p}" alt="" loading="lazy">`).join('')}</div>` : ''}
        </div>`;
    }).join('');
}

// ===== STATS =====
function renderStats() {
    const container = document.getElementById('statsContent');
    if (locations.length === 0) {
        container.innerHTML = `<div class="empty-state"><div class="empty-icon">üìä</div><h3>Noch keine Daten</h3><p>F√ºge Orte hinzu um Statistiken zu sehen!</p></div>`;
        return;
    }

    const totalLocs = locations.length;
    const visited = locations.filter(l => l.status !== 'wishlist');
    const avgRating = visited.length > 0 ? (visited.reduce((s, l) => s + (l.rating || 0), 0) / visited.length).toFixed(1) : '‚Äì';
    const totalVisits = locations.reduce((s, l) => s + (l.visitCount || 0), 0);
    const favCount = locations.filter(l => l.favorite).length;
    const wishCount = locations.filter(l => l.status === 'wishlist').length;
    const withPhotos = locations.filter(l => l.photos && l.photos.length > 0).length;

    // Category breakdown
    const catCounts = {};
    Object.keys(CATEGORIES).forEach(k => { catCounts[k] = locations.filter(l => l.category === k).length; });
    const maxCatCount = Math.max(...Object.values(catCounts), 1);

    // Top rated
    const topRated = [...locations].filter(l => l.rating > 0).sort((a, b) => b.rating - a.rating).slice(0, 5);

    // Most visited
    const mostVisited = [...locations].filter(l => l.visitCount > 0).sort((a, b) => (b.visitCount || 0) - (a.visitCount || 0)).slice(0, 5);

    // Tags analysis
    const tagCounts = {};
    locations.forEach(l => { if (l.tags) l.tags.forEach(t => { tagCounts[t] = (tagCounts[t] || 0) + 1; }); });
    const topTags = Object.entries(tagCounts).sort((a, b) => b[1] - a[1]).slice(0, 8);

    // Monthly activity
    const monthlyActivity = {};
    locations.forEach(l => {
        if (l.visits) {
            l.visits.forEach(v => {
                const m = v.date.substring(0, 7);
                monthlyActivity[m] = (monthlyActivity[m] || 0) + 1;
            });
        }
    });
    const months = Object.entries(monthlyActivity).sort((a, b) => a[0].localeCompare(b[0])).slice(-6);
    const maxMonth = Math.max(...months.map(m => m[1]), 1);

    let html = '';

    // Overview cards
    html += `<div class="stat-grid animate-in">
        <div class="stat-card"><div class="stat-value">${totalLocs}</div><div class="stat-label">Orte gesamt</div></div>
        <div class="stat-card"><div class="stat-value">${avgRating}</div><div class="stat-label">‚≠ê Durchschnitt</div></div>
        <div class="stat-card"><div class="stat-value">${totalVisits}</div><div class="stat-label">Besuche gesamt</div></div>
        <div class="stat-card"><div class="stat-value">${favCount}</div><div class="stat-label">‚ù§Ô∏è Favoriten</div></div>
    </div>`;

    // Additional stats row
    html += `<div class="stat-grid animate-in delay-1" style="margin-bottom:24px">
        <div class="stat-card"><div class="stat-value">${wishCount}</div><div class="stat-label">üéØ Merkliste</div></div>
        <div class="stat-card"><div class="stat-value">${withPhotos}</div><div class="stat-label">üì∑ Mit Fotos</div></div>
    </div>`;

    // Category chart
    html += `<div class="stat-section animate-in delay-2"><h3>üìÇ Nach Kategorie</h3><div class="chart-container">`;
    Object.entries(CATEGORIES).forEach(([key, cat]) => {
        const count = catCounts[key] || 0;
        const pct = (count / maxCatCount * 100).toFixed(0);
        html += `<div class="chart-row">
            <div class="chart-icon">${cat.icon}</div>
            <div class="chart-bar-bg"><div class="chart-bar-fg" style="width:${pct}%; background:${cat.color}">${cat.label}</div></div>
            <div class="chart-count">${count}</div>
        </div>`;
    });
    html += `</div></div>`;

    // Top Rated
    if (topRated.length > 0) {
        html += `<div class="stat-section animate-in delay-3"><h3>‚≠ê Am besten bewertet</h3>`;
        topRated.forEach(loc => {
            const cat = CATEGORIES[loc.category] || CATEGORIES.sonstiges;
            html += `<div class="stat-bar-wrap">
                <div class="stat-bar-label"><span class="name">${cat.icon} ${escHtml(loc.name)}</span><span class="value">${'‚òÖ'.repeat(loc.rating)}</span></div>
                <div class="stat-bar"><div class="stat-bar-fill" style="width:${loc.rating / 5 * 100}%"></div></div>
            </div>`;
        });
        html += `</div>`;
    }

    // Most Visited
    if (mostVisited.length > 0) {
        const maxV = mostVisited[0].visitCount || 1;
        html += `<div class="stat-section animate-in delay-4"><h3>üë£ Meistbesucht</h3>`;
        mostVisited.forEach(loc => {
            const cat = CATEGORIES[loc.category] || CATEGORIES.sonstiges;
            html += `<div class="stat-bar-wrap">
                <div class="stat-bar-label"><span class="name">${cat.icon} ${escHtml(loc.name)}</span><span class="value">${loc.visitCount}√ó</span></div>
                <div class="stat-bar"><div class="stat-bar-fill" style="width:${(loc.visitCount || 0) / maxV * 100}%"></div></div>
            </div>`;
        });
        html += `</div>`;
    }

    // Monthly Activity
    if (months.length > 0) {
        html += `<div class="stat-section animate-in"><h3>üìÖ Monatliche Aktivit√§t</h3><div class="chart-container">`;
        months.forEach(([month, count]) => {
            const pct = (count / maxMonth * 100).toFixed(0);
            const label = new Date(month + '-01').toLocaleDateString('de-DE', { month: 'short', year: '2-digit' });
            html += `<div class="chart-row">
                <div class="chart-icon" style="font-size:12px; width:50px">${label}</div>
                <div class="chart-bar-bg"><div class="chart-bar-fg" style="width:${pct}%; background:linear-gradient(90deg, var(--accent), var(--accent-blue))">${count}</div></div>
                <div class="chart-count">${count}</div>
            </div>`;
        });
        html += `</div></div>`;
    }

    // Top Tags
    if (topTags.length > 0) {
        html += `<div class="stat-section animate-in"><h3>üè∑Ô∏è H√§ufigste Tags</h3>
            <div style="display:flex; flex-wrap:wrap; gap:8px">
            ${topTags.map(([tag, count]) => `<span class="card-tag" style="font-size:13px; padding:5px 12px">${tag} (${count})</span>`).join('')}
            </div>
        </div>`;
    }

    container.innerHTML = html;

    // Animate bars
    requestAnimationFrame(() => {
        container.querySelectorAll('.stat-bar-fill, .chart-bar-fg').forEach(el => {
            const w = el.style.width;
            el.style.width = '0%';
            requestAnimationFrame(() => { el.style.width = w; });
        });
    });
}

// ===== SETTINGS =====
function renderSettings() {
    const container = document.getElementById('settingsContent');
    let html = '';

    // Map Style
    html += `<div class="setting-group"><h3>üó∫Ô∏è Kartenstil</h3>
        <div class="map-style-grid">
            ${Object.entries(MAP_STYLES).map(([key, s]) => `
                <div class="map-style-option${settings.mapStyle === key ? ' selected' : ''}" data-style="${key}">
                    <span class="style-icon">${s.icon}</span>${s.name}
                </div>
            `).join('')}
        </div>
    </div>`;

    // Toggles
    html += `<div class="setting-group"><h3>‚ö° Funktionen</h3>
        <div class="setting-item">
            <div class="setting-info"><div class="name">Marker gruppieren</div><div class="desc">Nahe Pins zusammenfassen</div></div>
            <button class="toggle${settings.clusterMarkers ? ' on' : ''}" data-setting="clusterMarkers"></button>
        </div>
        <div class="setting-item">
            <div class="setting-info"><div class="name">L√∂schen best√§tigen</div><div class="desc">Sicherheitsnachfrage vor dem L√∂schen</div></div>
            <button class="toggle${settings.confirmDelete ? ' on' : ''}" data-setting="confirmDelete"></button>
        </div>
        <div class="setting-item">
            <div class="setting-info"><div class="name">Besuchsz√§hler anzeigen</div><div class="desc">Anzahl Besuche auf Karten anzeigen</div></div>
            <button class="toggle${settings.showVisitCount ? ' on' : ''}" data-setting="showVisitCount"></button>
        </div>
        <div class="setting-item">
            <div class="setting-info"><div class="name">Auto-Standort</div><div class="desc">Beim Start Standort ermitteln</div></div>
            <button class="toggle${settings.autoLocate ? ' on' : ''}" data-setting="autoLocate"></button>
        </div>
    </div>`;

    // Default Category
    html += `<div class="setting-group"><h3>üìÇ Standard-Kategorie</h3>
        <select class="form-select" id="defaultCatSelect" style="margin-bottom:8px">
            <option value="">Keine Vorauswahl</option>
            ${Object.entries(CATEGORIES).map(([k, c]) => `<option value="${k}"${settings.defaultCategory === k ? ' selected' : ''}>${c.icon} ${c.label}</option>`).join('')}
        </select>
    </div>`;

    // Data Management
    html += `<div class="setting-group"><h3>üíæ Daten</h3>
        <button class="setting-btn" id="exportBtn">üì§ Daten exportieren (JSON)</button>
        <button class="setting-btn" id="importBtn">üì• Daten importieren</button>
        <input type="file" id="importFile" accept=".json" style="display:none">
        <button class="setting-btn" id="exportCSVBtn">üìä Als CSV exportieren</button>
        <button class="setting-btn danger" id="resetBtn">üóëÔ∏è Alle Daten l√∂schen</button>
    </div>`;

    // About
    html += `<div class="setting-group"><h3>‚ÑπÔ∏è Info</h3>
        <div class="setting-item" style="flex-direction:column; align-items:flex-start; gap:8px">
            <div class="name">Magdeburg Freizeitkarte v2.0</div>
            <div style="font-size:12px; color:var(--text-muted); line-height:1.5">
                Erstellt f√ºr Marc & Familie üè°<br>
                Orte: ${locations.length} ‚Ä¢ Fotos: ${locations.reduce((s, l) => s + (l.photos ? l.photos.length : 0), 0)}<br>
                Speicher: ${(JSON.stringify(locations).length / 1024).toFixed(0)} KB verwendet
            </div>
        </div>
    </div>`;

    container.innerHTML = html;
    attachSettingsEvents();
}

function attachSettingsEvents() {
    // Map style
    document.querySelectorAll('.map-style-option').forEach(el => {
        el.addEventListener('click', () => {
            document.querySelectorAll('.map-style-option').forEach(e => e.classList.remove('selected'));
            el.classList.add('selected');
            setMapStyle(el.dataset.style);
            toast(`üó∫Ô∏è Kartenstil: ${MAP_STYLES[el.dataset.style].name}`);
        });
    });

    // Toggles
    document.querySelectorAll('.toggle[data-setting]').forEach(el => {
        el.addEventListener('click', () => {
            const key = el.dataset.setting;
            settings[key] = !settings[key];
            el.classList.toggle('on');
            saveSettings();
            if (key === 'clusterMarkers') refreshMarkers();
            toast(`${settings[key] ? '‚úÖ' : '‚ùå'} ${el.closest('.setting-item').querySelector('.name').textContent}`);
        });
    });

    // Default category
    const catSel = document.getElementById('defaultCatSelect');
    if (catSel) catSel.addEventListener('change', () => {
        settings.defaultCategory = catSel.value;
        saveSettings();
    });

    // Export
    document.getElementById('exportBtn')?.addEventListener('click', exportData);
    document.getElementById('exportCSVBtn')?.addEventListener('click', exportCSV);

    // Import
    document.getElementById('importBtn')?.addEventListener('click', () => document.getElementById('importFile').click());
    document.getElementById('importFile')?.addEventListener('change', importData);

    // Reset
    document.getElementById('resetBtn')?.addEventListener('click', () => {
        showConfirm('Alle Daten l√∂schen?', 'Diese Aktion kann nicht r√ºckg√§ngig gemacht werden!', async () => {
            const tx = db.transaction('locations', 'readwrite');
            tx.objectStore('locations').clear();
            await loadLocations();
            refreshMarkers();
            renderSettings();
            toast('üóëÔ∏è Alle Daten gel√∂scht');
        });
    });
}

// ===== EXPORT/IMPORT =====
function exportData() {
    const data = {
        version: 2,
        exported: new Date().toISOString(),
        locations: locations,
        settings: settings
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `magdeburg-freizeit-backup-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    toast('üì§ Backup gespeichert');
}

function exportCSV() {
    const headers = ['Name', 'Kategorie', 'Bewertung', 'Status', 'Favorit', 'Letzter Besuch', 'Besuche', 'Lat', 'Lng', 'Tags', 'Notizen', 'Google Maps'];
    const rows = locations.map(l => [
        `"${l.name}"`, CATEGORIES[l.category]?.label || l.category, l.rating || 0,
        l.status || 'visited', l.favorite ? 'Ja' : 'Nein', l.lastVisit || '',
        l.visitCount || 0, l.lat, l.lng,
        `"${(l.tags || []).join(', ')}"`, `"${(l.notes || '').replace(/"/g, '""')}"`,
        l.mapsLink || ''
    ]);
    const csv = [headers.join(';'), ...rows.map(r => r.join(';'))].join('\n');
    const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `magdeburg-freizeit-${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    URL.revokeObjectURL(url);
    toast('üìä CSV exportiert');
}

async function importData(e) {
    const file = e.target.files[0];
    if (!file) return;
    try {
        const text = await file.text();
        const data = JSON.parse(text);
        if (!data.locations || !Array.isArray(data.locations)) throw new Error('Ung√ºltige Datei');

        showConfirm(
            'Daten importieren?',
            `${data.locations.length} Orte gefunden. Vorhandene Orte mit gleicher ID werden √ºberschrieben.`,
            async () => {
                for (const loc of data.locations) {
                    await dbPut('locations', loc);
                }
                if (data.settings) {
                    settings = { ...settings, ...data.settings };
                    await saveSettings();
                }
                await loadLocations();
                refreshMarkers();
                toast(`‚úÖ ${data.locations.length} Orte importiert`);
            }
        );
    } catch (err) {
        toast('‚ùå Fehler beim Import: ' + err.message, 'error');
    }
    e.target.value = '';
}

// ===== SETTINGS PERSISTENCE =====
async function loadSettings() {
    try {
        const stored = await new Promise((resolve, reject) => {
            const req = dbTransaction('settings', 'readonly').get('appSettings');
            req.onsuccess = () => resolve(req.result);
            req.onerror = () => reject(req.error);
        });
        if (stored && stored.value) {
            settings = { ...settings, ...stored.value };
        }
    } catch (e) { /* use defaults */ }
}

async function saveSettings() {
    try {
        await dbPut('settings', { key: 'appSettings', value: settings });
    } catch (e) { console.error('Settings save error:', e); }
}

// ===== LOCATION (GPS) =====
function locateUser() {
    if (!navigator.geolocation) {
        toast('Standort nicht verf√ºgbar', 'error');
        return;
    }
    const btn = document.getElementById('locateBtn');
    btn.classList.add('locating');
    navigator.geolocation.getCurrentPosition(
        (pos) => {
            btn.classList.remove('locating');
            userPosition = [pos.coords.latitude, pos.coords.longitude];
            map.setView(userPosition, 15);

            // Show accuracy circle
            if (window._userCircle) map.removeLayer(window._userCircle);
            if (window._userMarker) map.removeLayer(window._userMarker);
            window._userMarker = L.marker(userPosition, {
                icon: L.divIcon({
                    className: '',
                    html: `<div style="width:16px;height:16px;border-radius:50%;background:#4facfe;border:3px solid #fff;box-shadow:0 0 12px rgba(79,172,254,0.6);transform:translate(-8px,-8px)"></div>`,
                    iconSize: [0, 0]
                })
            }).addTo(map);
            window._userCircle = L.circle(userPosition, {
                radius: pos.coords.accuracy,
                color: '#4facfe', fillColor: '#4facfe',
                fillOpacity: 0.1, weight: 1
            }).addTo(map);
        },
        (err) => {
            btn.classList.remove('locating');
            toast('Standort nicht ermittelbar: ' + err.message, 'error');
        },
        { enableHighAccuracy: true, timeout: 10000 }
    );
}

// ===== PANEL MANAGEMENT =====
function openPanel(name) {
    closeAllPanels();
    const panel = document.getElementById(name + 'Panel');
    if (panel) {
        requestAnimationFrame(() => panel.classList.add('open'));
    }
    if (name === 'list') renderList();
    if (name === 'stats') renderStats();
    if (name === 'settings') renderSettings();
}

function closeAllPanels() {
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('open'));
}

// ===== NAVIGATION =====
function switchView(view) {
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.querySelector(`.nav-item[data-view="${view}"]`)?.classList.add('active');

    if (view === 'map') {
        closeAllPanels();
        map.invalidateSize();
    } else {
        openPanel(view);
    }
}

// ===== CONFIRM DIALOG =====
function showConfirm(title, msg, onYes) {
    document.getElementById('confirmTitle').textContent = title;
    document.getElementById('confirmMsg').textContent = msg;
    document.getElementById('confirmOverlay').classList.add('open');
    document.getElementById('confirmYes').onclick = () => {
        document.getElementById('confirmOverlay').classList.remove('open');
        onYes();
    };
    document.getElementById('confirmNo').onclick = () => {
        document.getElementById('confirmOverlay').classList.remove('open');
    };
}

async function deleteLocation(id) {
    await dbDelete('locations', id);
    await loadLocations();
    refreshMarkers();
    closeAllPanels();
    toast('üóëÔ∏è Ort gel√∂scht');
}

function confirmDeleteLocation(id) {
    const loc = locations.find(l => l.id === id);
    if (!loc) return;
    if (settings.confirmDelete) {
        showConfirm('Ort l√∂schen?', `"${loc.name}" wird unwiderruflich gel√∂scht.`, () => deleteLocation(id));
    } else {
        deleteLocation(id);
    }
}

// ===== TOAST =====
function toast(msg, type = 'success') {
    const container = document.getElementById('toastContainer');
    const el = document.createElement('div');
    el.className = `toast ${type}`;
    el.textContent = msg;
    container.appendChild(el);
    setTimeout(() => el.remove(), 3000);
}

// ===== HELPERS =====
function escHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

function isValidUrl(url) {
    if (!url) return true; // Leer ist erlaubt (optional)
    try {
        const u = new URL(url);
        return u.protocol === 'https:' || u.protocol === 'http:';
    } catch {
        return false;
    }
}

function sanitizeUrl(url) {
    if (!url) return '';
    return isValidUrl(url) ? url : '';
}

function showUrlError(inputId, hintId) {
    document.getElementById(inputId).classList.add('input-error');
    const hint = document.getElementById(hintId);
    hint.style.display = 'block';
    document.getElementById(inputId).scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function clearUrlError(inputId, hintId) {
    document.getElementById(inputId).classList.remove('input-error');
    document.getElementById(hintId).style.display = 'none';
}

function formatDate(dateStr) {
    if (!dateStr) return '';
    try {
        return new Date(dateStr).toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
    } catch { return dateStr; }
}

function getDistance(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon / 2) * Math.sin(dLon / 2);
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

async function loadLocations() {
    try {
        locations = await dbGetAll('locations');
    } catch (err) {
        console.error('Fehler beim Laden der Orte:', err);
        locations = [];
        throw err;
    }
}

function flyToLocation(id) {
    const loc = locations.find(l => l.id === id);
    if (!loc) return;
    closeAllPanels();
    switchView('map');
    map.flyTo([loc.lat, loc.lng], 17, { duration: 1 });
    if (markers[id]) markers[id].openPopup();
}

function editLocation(id) {
    const loc = locations.find(l => l.id === id);
    if (!loc) return;
    closeAllPanels();
    openModal(loc.lat, loc.lng, loc);
}

// ===== EVENT LISTENERS =====
function initEvents() {
    // FAB
    document.getElementById('addFab').addEventListener('click', () => {
        const center = map.getCenter();
        openModal(center.lat, center.lng, null);
    });

    // Modal
    document.getElementById('modalOverlay').addEventListener('click', closeModal);
    document.getElementById('modalClose').addEventListener('click', closeModal);
    document.getElementById('modalCancelBtn').addEventListener('click', closeModal);
    document.getElementById('locationForm').addEventListener('submit', saveLocation);

    // Category grid
    document.querySelectorAll('.cat-option').forEach(el => {
        el.addEventListener('click', () => {
            document.querySelectorAll('.cat-option').forEach(e => e.classList.remove('selected'));
            el.classList.add('selected');
            selectedCategory = el.dataset.cat;
        });
    });

    // Status buttons
    ['statusVisited', 'statusWishlist'].forEach(id => {
        document.getElementById(id).addEventListener('click', () => {
            const status = id === 'statusVisited' ? 'visited' : 'wishlist';
            const fav = document.getElementById('statusFavorite').classList.contains('active-favorite');
            updateStatusButtons(status, fav);
        });
    });
    document.getElementById('statusFavorite').addEventListener('click', () => {
        const isVis = document.getElementById('statusVisited').classList.contains('active-visited');
        const status = isVis ? 'visited' : 'wishlist';
        const fav = !document.getElementById('statusFavorite').classList.contains('active-favorite');
        updateStatusButtons(status, fav);
    });

    // Tags
    document.getElementById('tagInput').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            addTag(e.target.value);
            e.target.value = '';
        }
    });
    document.getElementById('tagsWrap').addEventListener('click', (e) => {
        const btn = e.target.closest('.tag-remove');
        if (btn) removeTag(parseInt(btn.dataset.idx));
    });
    document.querySelectorAll('.tag-sug').forEach(el => {
        el.addEventListener('click', () => {
            addTag(el.dataset.tag);
        });
    });

    // Photos
    document.getElementById('photoInput').addEventListener('change', (e) => handlePhotoUpload(e.target.files));
    document.getElementById('photoPreview').addEventListener('click', (e) => {
        const btn = e.target.closest('.photo-remove');
        if (btn) {
            currentPhotos.splice(parseInt(btn.dataset.idx), 1);
            renderPhotoPreview();
        }
    });

    // Search
    document.getElementById('searchToggle').addEventListener('click', () => {
        const bar = document.getElementById('searchBar');
        const open = bar.classList.toggle('visible');
        document.getElementById('map').classList.toggle('search-open', open);
        document.getElementById('categoryBar').classList.toggle('search-open', open);
        document.getElementById('searchToggle').classList.toggle('active', open);
        if (open) document.getElementById('searchInput').focus();
        else { document.getElementById('searchInput').value = ''; searchQuery = ''; refreshMarkers(); }
    });
    document.getElementById('searchInput').addEventListener('input', (e) => {
        searchQuery = e.target.value;
        document.getElementById('searchClear').classList.toggle('visible', searchQuery.length > 0);
        refreshMarkers();
    });
    document.getElementById('searchClear').addEventListener('click', () => {
        document.getElementById('searchInput').value = '';
        searchQuery = '';
        document.getElementById('searchClear').classList.remove('visible');
        refreshMarkers();
    });

    // Category chips
    document.querySelectorAll('.chip').forEach(chip => {
        chip.addEventListener('click', () => {
            document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            chip.classList.add('active');
            currentFilter = chip.dataset.filter;
            refreshMarkers();
        });
    });

    // Map controls
    document.getElementById('locateBtn').addEventListener('click', locateUser);
    document.getElementById('fitAllBtn').addEventListener('click', fitBounds);

    // Layer toggle (cycles styles)
    document.getElementById('layerToggle').addEventListener('click', () => {
        const keys = Object.keys(MAP_STYLES);
        const idx = (keys.indexOf(settings.mapStyle) + 1) % keys.length;
        setMapStyle(keys[idx]);
        toast(`üó∫Ô∏è ${MAP_STYLES[keys[idx]].name}`);
    });

    // Bottom nav
    document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', () => switchView(item.dataset.view));
    });

    // Panel close buttons
    document.getElementById('listClose').addEventListener('click', () => { closeAllPanels(); switchView('map'); });
    document.getElementById('statsClose').addEventListener('click', () => { closeAllPanels(); switchView('map'); });
    document.getElementById('settingsClose').addEventListener('click', () => { closeAllPanels(); switchView('map'); });
    document.getElementById('detailClose').addEventListener('click', () => { closeAllPanels(); switchView('map'); });

    // Sort buttons
    document.getElementById('listSort').addEventListener('click', (e) => {
        const btn = e.target.closest('.sort-btn');
        if (!btn) return;
        document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentSort = btn.dataset.sort;
        renderList();
    });

    // Photo viewer
    document.getElementById('photoViewerClose').addEventListener('click', () => {
        document.getElementById('photoViewer').classList.remove('open');
    });
    document.getElementById('photoViewer').addEventListener('click', (e) => {
        if (e.target === document.getElementById('photoViewer')) {
            document.getElementById('photoViewer').classList.remove('open');
        }
    });

    // URL-Felder ‚Äì Validierungsfehler beim Tippen zur√ºcksetzen
    document.getElementById('fMapsLink').addEventListener('input', () => clearUrlError('fMapsLink', 'mapsLinkHint'));
    document.getElementById('fWebsite').addEventListener('input', () => clearUrlError('fWebsite', 'websiteHint'));
}

// ===== PUBLIC API =====
window.APP = {
    openModalAt: (lat, lng) => {
        map.closePopup();
        openModal(lat, lng, null);
    },
    showDetail,
    editLocation,
    flyToLocation,
    confirmDelete: confirmDeleteLocation,
    shareLocation,
    viewPhoto,
    addVisit
};

// ===== INIT =====
async function init() {
    try {
        await openDB();
        await loadSettings();
        await loadLocations();
        initMap();
        initEvents();
        refreshMarkers();

        if (settings.autoLocate) locateUser();
    } catch (err) {
        console.error('Initialisierungsfehler:', err);
        document.body.innerHTML = `
            <div style="display:flex;align-items:center;justify-content:center;height:100vh;padding:20px;text-align:center;font-family:Nunito,sans-serif;color:#e8f0f8;background:#0f1923">
                <div>
                    <div style="font-size:56px;margin-bottom:20px">‚ùå</div>
                    <h2 style="font-size:22px;margin-bottom:10px">Fehler beim Laden der App</h2>
                    <p style="color:#8ba4be;margin-bottom:24px;line-height:1.6">
                        Die Datenbank konnte nicht ge√∂ffnet werden.<br>
                        Bitte lade die Seite neu oder √ºberpr√ºfe deine Browser-Einstellungen.
                    </p>
                    <button onclick="location.reload()" style="padding:14px 28px;background:#00d4aa;color:#fff;border:none;border-radius:10px;font-family:Nunito;font-weight:700;cursor:pointer;font-size:16px">
                        üîÑ Neu laden
                    </button>
                </div>
            </div>
        `;
        return;
    }

    // PWA Installationsbanner
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
    });
}

init();
})();

// Service Worker registrieren
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./service-worker.js')
        .then(reg => console.log('SW registriert:', reg.scope))
        .catch(err => console.warn('SW Fehler:', err));
}
</script>
</body>
</html>
